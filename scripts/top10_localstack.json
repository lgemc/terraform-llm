[
  {
    "index": 302,
    "difficulty": 6,
    "resource_types": [
      "aws_api_gateway_rest_api",
      "aws_api_gateway_method",
      "aws_api_gateway_integration",
      "aws_iam_role",
      "aws_lambda_function",
      "aws_s3_bucket",
      "aws_dynamodb_table",
      "aws_api_gateway_resource",
      "aws_iam_role_policy",
      "aws_lambda_permission",
      "aws_api_gateway_stage",
      "aws_api_gateway_deployment"
    ],
    "num_resources": 12,
    "Resource": "aws_api_gateway_method, aws_api_gateway_method, aws_api_gateway_resource, aws_api_gateway_rest_api, aws_s3_bucket",
    "Prompt": "An AWS service that holds a web server which allows you to upload cat pictures and provides random cat pictures on demand. Accomplishes this with API Gateway and S3.",
    "Rego intent": "package caas_high\n\nimport rego.v1\n\napi_valid(api) := true\n\ncat_valid(cat, api) if {\n\tapi.address in cat.expressions.parent_id.references\n\tapi.address in cat.expressions.rest_api_id.references\n}\n\nmethod_valid(method, method_string, resource, api) if {\n\tmethod.expressions.http_method.constant_value == method_string\n\tresource.address in method.expressions.resource_id.references\n\tapi.address in method.expressions.rest_api_id.references\n\tmethod.expressions.authorization\n}\n\ndefault valid := false\n\nvalid if {\n\tresources := input.configuration.root_module.resources\n\n\tsome api in resources\n\tapi.type == \"aws_api_gateway_rest_api\"\n\n\tsome cat in resources\n\tcat.type == \"aws_api_gateway_resource\"\n\n\tsome method_get in resources\n\tmethod_get.type == \"aws_api_gateway_method\"\n\n\tsome method_put in resources\n\tmethod_put.type == \"aws_api_gateway_method\"\n\n\tsome bucket in resources\n\tbucket.type == \"aws_s3_bucket\"\n\n\tapi_valid(api)\n\tcat_valid(cat, api)\n\tmethod_valid(method_get, \"GET\", cat, api)\n\tmethod_valid(method_put, \"PUT\", cat, api)\n}",
    "Difficulty": 6,
    "Reference output": "terraform {\n  required_providers {\n    aws = {\n      source  = \"hashicorp/aws\"\n      version = \"~> 5.75\"\n    }\n  }\n\n  required_version = \"~> 1.9.8\"\n}\n\n\nprovider \"aws\" {\n  region  = \"us-east-1\"\n  profile = \"admin-1\"\n\n  assume_role {\n    role_arn = \"arn:aws:iam::590184057477:role/yicun-iac\"\n  }\n}\n\nresource \"aws_dynamodb_table\" \"caas\" {\n  name           = \"cat_names\"\n  hash_key       = \"name\"\n  billing_mode   = \"PAY_PER_REQUEST\"\n\n  attribute {\n    name = \"name\"\n    type = \"S\"\n  }\n}\n\nresource \"aws_s3_bucket\" \"caas\" {\n  bucket_prefix = \"cat-image\"\n}\n\nresource \"aws_iam_role\" \"lambda_role\" {\n  name = \"lambda_api_gateway_role\"\n\n  assume_role_policy = jsonencode({\n    Version = \"2012-10-17\"\n    Statement = [\n      {\n        Action = \"sts:AssumeRole\"\n        Effect = \"Allow\"\n        Principal = {\n          Service = \"lambda.amazonaws.com\"\n        }\n      }\n    ]\n  })\n}\n\nresource \"aws_iam_role_policy\" \"lambda_policy\" {\n  name   = \"lambda_policy\"\n  role   = aws_iam_role.lambda_role.id\n  policy = jsonencode({\n    Version = \"2012-10-17\"\n    Statement = [\n      {\n        Action = [\n          \"s3:GetObject\",\n          \"s3:PutObject\"\n        ]\n        Effect   = \"Allow\"\n        Resource = \"${aws_s3_bucket.caas.arn}/*\"\n      },\n      {\n        Action = [\n          \"dynamodb:PutItem\"\n        ]\n        Effect   = \"Allow\"\n        Resource = aws_dynamodb_table.caas.arn\n      }\n    ]\n  })\n}\n\nresource \"aws_api_gateway_rest_api\" \"caas\" {\n  name = \"caas\"\n}\n\nresource \"aws_api_gateway_resource\" \"caas_cat\" {\n  rest_api_id = aws_api_gateway_rest_api.caas.id\n  parent_id   = aws_api_gateway_rest_api.caas.root_resource_id\n  path_part   = \"cat\"\n}\n\nresource \"aws_api_gateway_method\" \"caas_cat_get\" {\n  rest_api_id   = aws_api_gateway_rest_api.caas.id\n  resource_id   = aws_api_gateway_resource.caas_cat.id\n  http_method   = \"GET\"\n  authorization = \"NONE\"\n}\n\nresource \"aws_api_gateway_method\" \"caas_cat_put\" {\n  rest_api_id   = aws_api_gateway_rest_api.caas.id\n  resource_id   = aws_api_gateway_resource.caas_cat.id\n  http_method   = \"PUT\"\n  authorization = \"NONE\"\n}\n\ndata \"archive_file\" \"caas_cat\" {\n  type        = \"zip\"\n  source_file = \"./supplement/caas_cat.py\"\n  output_path = \"./supplement/caas_cat.zip\"\n}\n\nresource \"aws_lambda_function\" \"caas_cat\" {\n  function_name = \"caas_cat\"\n  role          = aws_iam_role.lambda_role.arn\n  filename      = data.archive_file.caas_cat.output_path\n  source_code_hash = data.archive_file.caas_cat.output_base64sha256\n  handler       = \"caas_cat.handler\"\n  runtime       = \"python3.12\"\n\n  environment {\n    variables = {\n      CAAS_S3_BUCKET = \"${aws_s3_bucket.caas.id}\"\n      DYNAMODB_TABLE_NAME = \"${aws_dynamodb_table.caas.id}\"\n    }\n  }\n}\n\nresource \"aws_api_gateway_integration\" \"caas_cat_get\" {\n  rest_api_id             = aws_api_gateway_rest_api.caas.id\n  resource_id             = aws_api_gateway_resource.caas_cat.id\n  http_method             = aws_api_gateway_method.caas_cat_get.http_method\n  type                    = \"AWS_PROXY\"\n  integration_http_method = \"GET\"\n  uri                     = aws_lambda_function.caas_cat.invoke_arn\n}\n\nresource \"aws_api_gateway_integration\" \"caas_cat_put\" {\n  rest_api_id             = aws_api_gateway_rest_api.caas.id\n  resource_id             = aws_api_gateway_resource.caas_cat.id\n  http_method             = aws_api_gateway_method.caas_cat_put.http_method\n  type                    = \"AWS_PROXY\"\n  integration_http_method = \"PUT\"\n  uri                     = aws_lambda_function.caas_cat.invoke_arn\n}\n\nresource \"aws_lambda_permission\" \"caas_cat\" {\n  action        = \"lambda:InvokeFunction\"\n  principal     = \"apigateway.amazonaws.com\"\n  function_name = aws_lambda_function.caas_cat.function_name\n\n  source_arn = \"${aws_api_gateway_rest_api.caas.execution_arn}/*/*\"\n}\n\nresource \"aws_api_gateway_deployment\" \"api_deployment\" {\n  rest_api_id = aws_api_gateway_rest_api.caas.id\n  depends_on  = [aws_api_gateway_integration.caas_cat_get, \n                 aws_api_gateway_integration.caas_cat_put]\n}\n\nresource \"aws_api_gateway_stage\" \"api_stage\" {\n  deployment_id = aws_api_gateway_deployment.api_deployment.id\n  rest_api_id   = aws_api_gateway_rest_api.caas.id\n  stage_name    = \"dev\"\n}\n\noutput \"api_id\" {\n  value = aws_api_gateway_rest_api.caas.id\n  description = \"The API Gateway ID\"\n}",
    "Intent": "have one \"aws_api_gateway_rest_api\" resource\n    with \"name\" argument\nhave one \"aws_api_gateway_resource\" resource\n    with \"rest_api_id\" argument linking to aws_api_gateway_rest_api resource id\n    with \"parent_id\" argument linking to aws_api_gateway_rest_api resource root_resource_id\n    with \"path_part\" argument\nhave two \"aws_api_gateway_method\" resources\n    with \"rest_api_id\" argument linking to aws_api_gateway_rest_api resource\n    with \"resource_id\" argument linking to aws_api_gateway_resource\n    with \"http_method\" argument with values \"GET\" and \"PUT\"\n    with \"authorization\" argument\nhave one \"aws_s3_bucket\" resource"
  },
  {
    "index": 437,
    "difficulty": 6,
    "resource_types": [
      "aws_subnet",
      "aws_security_group",
      "aws_vpc",
      "aws_route_table",
      "aws_db_subnet_group",
      "aws_route_table_association",
      "aws_internet_gateway"
    ],
    "num_resources": 7,
    "Resource": "aws_db_subnet_group, aws_internet_gateway, aws_route_table, aws_route_table_association, aws_route_table_association, aws_security_group, aws_subnet, aws_subnet, aws_vpc",
    "Prompt": "Set up a VPC in the AWS region with two subnets in different availability zones, an internet gateway, and a route table for internet access. It also defines a security group to allow access to MySQL and PostgreSQL databases on their default ports from any IP address and creates a database subnet group including both subnets.",
    "Rego intent": "package terraform.validation\n\n# Set default validation states\ndefault is_valid_vpc = false\n\ndefault is_valid_internet_gateway = false\n\ndefault is_valid_route_table = false\n\ndefault is_valid_subnets1 = false\n\ndefault is_valid_subnets2 = false\n\ndefault is_valid_security_group = false\n\ndefault is_valid_db_subnet_group = false\n\n# Validate aws_vpc resource\nis_valid_vpc {\n        some i\n        resource := input.configuration.root_module.resources[i]\n        resource.type == \"aws_vpc\"\n        resource.expressions.cidr_block.constant_value != null\n}\n\n# Validate aws_subnet resources\nis_valid_subnets1 {\n        some i\n        resource := input.configuration.root_module.resources[i]\n        resource.type == \"aws_subnet\"\n        resource.expressions.vpc_id.references[0] == \"aws_vpc.main.id\"\n        resource.expressions.availability_zone.constant_value == \"us-west-1a\"\n}\n\nis_valid_subnets2 {\n        some i\n        resource := input.configuration.root_module.resources[i]\n        resource.type == \"aws_subnet\"\n        resource.expressions.vpc_id.references[0] == \"aws_vpc.main.id\"\n        resource.expressions.availability_zone.constant_value == \"us-west-1b\"\n}\n\n# Validate aws_internet_gateway resource\nis_valid_internet_gateway {\n        some i\n        resource := input.configuration.root_module.resources[i]\n        resource.type == \"aws_internet_gateway\"\n        resource.expressions.vpc_id.references[0] == \"aws_vpc.main.id\"\n}\n\n# Validate aws_route_table resource\nis_valid_route_table {\n        some i\n        resource := input.configuration.root_module.resources[i]\n        resource.type == \"aws_route_table\"\n        resource.expressions.vpc_id.references[0] == \"aws_vpc.main.id\"\n        resource.expressions.route.references[0] == \"aws_internet_gateway.gateway.id\"\n}\n\n# Validate aws_security_group resource\nis_valid_security_group {\n        some i\n        resource := input.configuration.root_module.resources[i]\n        resource.type == \"aws_security_group\"\n        resource.expressions.vpc_id.references[0] == \"aws_vpc.main.id\"\n    some j\n        port1 := resource.expressions.ingress.constant_value[j]\n    port1.from_port == 3306\n    some k\n        port2 := resource.expressions.ingress.constant_value[k]\n    port2.from_port == 5432\n}\n\n# Validate aws_db_subnet_group resource\nis_valid_db_subnet_group {\n        some i\n        resource := input.configuration.root_module.resources[i]\n        resource.type == \"aws_db_subnet_group\"\n}\n",
    "Difficulty": 6,
    "Reference output": "terraform {\n  required_providers {\n    aws = {\n      source  = \"hashicorp/aws\"\n      version = \"~> 5.75\"\n    }\n  }\n\n  required_version = \"~> 1.9.8\"\n}\n\nprovider \"aws\" {\n  region  = \"us-east-1\"\n  profile = \"admin-1\"\n\n  assume_role {\n    role_arn = \"arn:aws:iam::590184057477:role/yicun-iac\"\n  }\n}\n\nresource \"aws_vpc\" \"main\" {\n  cidr_block           = \"10.0.0.0/16\"\n  enable_dns_hostnames = true\n}\n\ndata \"aws_availability_zones\" \"azs\" {\n    state = \"available\"\n}\n\nresource \"aws_subnet\" \"zonea\" {\n  vpc_id            = aws_vpc.main.id\n  cidr_block        = \"10.0.1.0/24\"\n  availability_zone = data.aws_availability_zones.azs.names[0]\n}\n\nresource \"aws_subnet\" \"zoneb\" {\n  vpc_id            = aws_vpc.main.id\n  cidr_block        = \"10.0.2.0/24\"\n  availability_zone = data.aws_availability_zones.azs.names[1]\n}\n\nresource \"aws_internet_gateway\" \"gateway\" {\n  vpc_id = aws_vpc.main.id\n}\n\nresource \"aws_route_table\" \"public\" {\n  vpc_id = aws_vpc.main.id\n\n  route {\n    cidr_block = \"0.0.0.0/0\"\n    gateway_id = aws_internet_gateway.gateway.id\n  }\n}\n\nresource \"aws_route_table_association\" \"publica\" {\n  subnet_id      = aws_subnet.zonea.id\n  route_table_id = aws_route_table.public.id\n}\n\nresource \"aws_route_table_association\" \"publicb\" {\n  subnet_id      = aws_subnet.zoneb.id\n  route_table_id = aws_route_table.public.id\n}\n\nresource \"aws_security_group\" \"allow-db-access\" {\n  name   = \"allow-all\"\n  vpc_id = aws_vpc.main.id\n\n  ingress {\n    from_port   = \"3306\"\n    to_port     = \"3306\"\n    protocol    = \"tcp\"\n    cidr_blocks = [\"0.0.0.0/0\"]\n  }\n\n  ingress {\n    from_port   = \"5432\"\n    to_port     = \"5432\"\n    protocol    = \"tcp\"\n    cidr_blocks = [\"0.0.0.0/0\"]\n  }\n}\n\nresource \"aws_db_subnet_group\" \"default\" {\n  subnet_ids = [aws_subnet.zonea.id, aws_subnet.zoneb.id]\n}",
    "Intent": "Has one \"aws_vpc\" resource:\nIncludes a \"cidr_block\" for network configuration\n\nHas two \"aws_subnet\" resources:\nBoth subnets are part of the \"aws_vpc\" resource\nEach subnet is located in a different availability zone: \"us-west-1a\" and \"us-west-1b\"\n\nHas one \"aws_internet_gateway\" resource:\nAttached to the \"aws_vpc\" resource\n\nHas one \"aws_route_table\" resource:\nAssociated with the \"aws_vpc\"\nContains a default route that directs traffic to the \"aws_internet_gateway\"\nApplied to both subnets to enable internet access\n\nHas one \"aws_security_group\" resource:\nAssociated with the \"aws_vpc\"\nConfigured to allow inbound traffic on the default ports for MySQL (TCP 3306) and PostgreSQL (TCP 5432) from any IP address\n\nHas one \"aws_db_subnet_group\" resource:\nIncludes both \"aws_subnet\" resources\nFacilitates the placement of databases in the specified subnets"
  },
  {
    "index": 4,
    "difficulty": 6,
    "resource_types": [
      "aws_route53_zone",
      "aws_db_instance",
      "aws_subnet",
      "aws_vpc",
      "aws_db_subnet_group",
      "aws_route53_record"
    ],
    "num_resources": 6,
    "Resource": "aws_db_instance, aws_db_instance, aws_db_subnet_group, aws_route53_record, aws_route53_record, aws_route53_zone, aws_route53_zone, aws_subnet, aws_subnet, aws_vpc",
    "Prompt": "Configure Route 53 to return different database endpoints to internal versus external users. Internal users are routed to an internal RDS instance, while external users are routed to a publicly accessible one. Name the zones \"private\" and \"public\", the databases \"internal\" and \"public\", and the subnet group \"main\"",
    "Rego intent": "package terraform.validation\n\ndefault is_configuration_valid = false\n\ndefault is_valid_r53_zone = false\n\ndefault is_valid_r53_record = false\n\ndefault is_valid_db_instance = false\n\ndefault is_valid_vpc = false\n\ndefault is_valid_subnet = false\n\ndefault is_valid_subnet_group = false\n\n\nis_valid_r53_zone {\n        some i, j\n    resource := input.configuration.root_module.resources[i]\n    resource.type == \"aws_route53_zone\"\n    resource.expressions.name\n    resource2 := input.configuration.root_module.resources[j]\n    resource2.type == \"aws_route53_zone\"\n    resource2.expressions.name\n    resource2.expressions.vpc[0].vpc_id.references[0]\n\n}\n\nis_valid_vpc {\n\t\tsome i\n    resource := input.configuration.root_module.resources[i]\n    resource.type == \"aws_vpc\"\n    resource.expressions.cidr_block\n}\n\nis_valid_r53_record {\n        some i, j\n    resource := input.configuration.root_module.resources[i]\n    resource.type == \"aws_route53_record\"\n    resource.expressions.name\n    resource.expressions.type\n    resource.expressions.ttl\n    resource.expressions.zone_id.references[0] == \"aws_route53_zone.public.zone_id\"\n    resource.expressions.records.references[0] == \"aws_db_instance.public.address\"\n\n    resource2 := input.configuration.root_module.resources[j]\n    resource2.type == \"aws_route53_record\"\n    resource2.expressions.name\n    resource2.expressions.type\n    resource2.expressions.ttl\n    resource2.expressions.zone_id.references[0] == \"aws_route53_zone.private.zone_id\"\n    resource2.expressions.records.references[0] == \"aws_db_instance.internal.address\"\n}\n\n\n\nis_valid_subnet {\n\t\tsome i, j\n    resource := input.configuration.root_module.resources[i]\n    resource.type == \"aws_subnet\"\n    resource.expressions.cidr_block\n    resource.expressions.availability_zone\n    \n    resource2 := input.configuration.root_module.resources[j]\n    resource2.type == \"aws_subnet\"\n    resource2.expressions.cidr_block\n    resource2.expressions.availability_zone\n    resource2.expressions.vpc_id.references[0] == resource.expressions.vpc_id.references[0]\n\n}\n\nis_valid_subnet_group {\n\t\tsome i\n    resource := input.configuration.root_module.resources[i]\n    resource.type == \"aws_db_subnet_group\"\n    resource.expressions.subnet_ids.references[0]\n}\n\nis_valid_db_instance {\n        some i\n        resource := input.configuration.root_module.resources[i]\n    resource.type == \"aws_db_instance\"\n    has_required_main_db_arguments\n}\n\n# Helper rule to check if all required arguments are present and valid\nhas_required_main_db_arguments {\n\t\tsome i, j\n    resource := input.configuration.root_module.resources[i]\n    resource.type == \"aws_db_instance\"\n    resource.expressions.db_subnet_group_name.references[0] == \"aws_db_subnet_group.main.name\"\n    resource2 := input.configuration.root_module.resources[j]\n    resource2.type == \"aws_db_instance\"\n    resource2.expressions.publicly_accessible.constant_value == true\n    # Check for allocated_storage, engine, instance_class, username, password, and skip_final_snapshot\n    requirement1(resource.expressions)\n    requirement1(resource2.expressions)\n    # Check for instance_class validity\n    requirement2(resource.expressions)\n    requirement2(resource2.expressions)\n}\n\n\n\n# 1, allocated_storage and engine or snapshot_identifier or replace_source_db\nrequirement1(expressions) {\n    expressions.allocated_storage\n    expressions.engine\n    expressions.username\n    expressions.password\n    is_valid_engine(expressions.engine.constant_value)\n}\n\nrequirement1(expressions) {\n    expressions.snapshot_identifier\n}\n\n# Check for instance_class validity\nrequirement2(expressions) {\n    expressions.instance_class\n    is_valid_instance_class(expressions.instance_class.constant_value)\n}\n\n\n# Helper rule to validate engine value\nis_valid_engine(engine) {\n        engine_set := {\n        \"mysql\",\n        \"postgres\",\n        \"mariadb\",\n        \"oracle-se\",\n        \"oracle-se1\",\n        \"oracle-se2\",\n        \"oracle-ee\",\n        \"sqlserver-ee\",\n        \"sqlserver-se\",\n        \"sqlserver-ex\",\n        \"sqlserver-web\"\n    }\n        engine_set[engine]\n}\n\n# Helper rule to validate instance class type\nis_valid_instance_class(instance_class) {\n        instance_class_starts_with(instance_class, \"db.\")\n}\n\n# Helper rule to check prefix of instance class\ninstance_class_starts_with(instance_class, prefix) {\n        startswith(instance_class, prefix)\n}\n\n\n# Combine all checks into a final rule\nis_configuration_valid {\n    is_valid_db_instance\n    is_valid_vpc\n    is_valid_subnet\n    is_valid_subnet_group\n    is_valid_r53_record\n    is_valid_r53_zone\n    \n}",
    "Difficulty": 6,
    "Reference output": "terraform {\n  required_providers {\n    aws = {\n      source  = \"hashicorp/aws\"\n      version = \"~> 5.75\"\n    }\n  }\n\n  required_version = \"~> 1.9.8\"\n}\n\n\nprovider \"aws\" {\n  region = \"us-east-1\" \n  profile = \"admin-1\"\n\n  assume_role {\n    role_arn = \"arn:aws:iam::590184057477:role/yicun-iac\"\n  }\n}\n\n# Create a VPC for internal resources\nresource \"aws_vpc\" \"main\" {\n  cidr_block = \"10.0.0.0/24\"\n}\n\n\n# RDS instances\nresource \"aws_db_instance\" \"internal\" {\n  # Internal DB configuration\n  allocated_storage    = 20\n  engine               = \"mysql\"\n  instance_class       = \"db.t3.micro\"\n  identifier =  \"internal\"\n  username             = \"user\"\n  password             = \"password\"\n  db_subnet_group_name = aws_db_subnet_group.main.name\n  skip_final_snapshot  = true\n}\n\nresource \"aws_db_instance\" \"public\" {\n  # Public DB configuration\n  publicly_accessible  = true\n  allocated_storage    = 20\n  engine               = \"mysql\"\n  instance_class       = \"db.t3.micro\"\n  identifier = \"public\"\n  username             = \"user\"\n  password             = \"password\"\n  skip_final_snapshot  = true\n}\n\nresource \"aws_db_subnet_group\" \"main\" {\n  name       = \"mydb-subnet-group\"\n  subnet_ids = [aws_subnet.maina.id, aws_subnet.mainb.id]\n}\n\ndata \"aws_availability_zones\" \"available\" {}\n\n# Subnet for RDS\nresource \"aws_subnet\" \"maina\" {\n  vpc_id            = aws_vpc.main.id\n  cidr_block        = \"10.0.0.0/25\"\n  availability_zone = data.aws_availability_zones.available.names[0]\n}\n\nresource \"aws_subnet\" \"mainb\" {\n  vpc_id            = aws_vpc.main.id\n  cidr_block        = \"10.0.0.128/25\"\n  availability_zone = data.aws_availability_zones.available.names[1]\n}\n\n# Route 53 Public Hosted Zone for external users\nresource \"aws_route53_zone\" \"public\" {\n  name = \"example53.com\"\n}\n\n# Route 53 Private Hosted Zone for internal users\nresource \"aws_route53_zone\" \"private\" {\n  name = \"example53.com\"\n  vpc {\n    vpc_id = aws_vpc.main.id\n  }\n}\n\n# Route 53 Record for Public DB (External Endpoint)\nresource \"aws_route53_record\" \"public_db\" {\n  zone_id = aws_route53_zone.public.zone_id\n  name    = \"public-db.example.com\"\n  type    = \"CNAME\"\n  ttl     = \"300\"\n  records = [aws_db_instance.public.address]\n}\n\n# Route 53 Record for Internal DB (Internal Endpoint)\nresource \"aws_route53_record\" \"internal_db\" {\n  zone_id = aws_route53_zone.private.zone_id\n  name    = \"internal-db.example.com\"\n  type    = \"CNAME\"\n  ttl     = \"300\"\n  records = [aws_db_instance.internal.address]\n}",
    "Intent": "Has one \"aws_vpc\" resource\n    with a specified \"cidr_block\"\n\nHas multiple \"aws_subnet\" resources\n    with \"vpc_id\" referencing the \"aws_vpc\" resource\n    with specified \"cidr_block\" for each\n    with \"availability_zone\" set\n\nHas one \"aws_db_subnet_group\" resource\n    with \"subnet_ids\" referencing the IDs of \"aws_subnet\" resources\n\nHas one \"aws_route53_zone\" resource\n    with \"name\"\n\nHas one \"aws_route53_zone\" resource\n    with \"name\"\n    with a \"vpc\" block with \"vpc_id\" referencing the \"aws_vpc\" resource\n\n\nHas one \"aws_db_instance\" resource for internal use\n    with \"allocated_storage\" set to a specific size\n    with a specified \"engine\" \n    with a specified \"instance_class\"\n    with \"username\" and \"password\"\n    with \"skip_final_snapshot\" set to true\n    with \"identifier\"\n    with \"password\"\n    with \"db_subnet_group_name\" referencing the \"aws_db_subnet_group\" resource\n\nHas one \"aws_db_instance\" resource for public use\n    with \"allocated_storage\" set to a specific size\n    with a specified \"engine\"\n    with a specified \"instance_class\"\n    with \"username\" and \"password\"\n    with \"skip_final_snapshot\" set to true\n    with \"identifier\"\n    with \"password\"\n    with \"publicly_accessible\" set to true\n\nHas two \"aws_route53_record\" resources\n    with \"zone_id\" referencing one of the \"aws_route53_zone\" resources\n    with \"type\"\n    with \"ttl\"\n    with \"records\" referencing one of the \"aws_db_instance\" resources \n"
  },
  {
    "index": 3,
    "difficulty": 6,
    "resource_types": [
      "aws_route53_zone",
      "aws_db_instance",
      "aws_route53_record"
    ],
    "num_resources": 3,
    "Resource": "aws_db_instance, aws_db_instance, aws_db_instance, aws_db_instance, aws_route53_record, aws_route53_record, aws_route53_record, aws_route53_zone",
    "Prompt": "Using route 53 resources, configure a weighted routing policy that splits users between three db_instances that are replicas of a main db_instance. Provision the three replica instances in \"us-east-1\", \"eu-central-1\", and \"ap-southeast-1\". Provision the zone and main db_instance in \"us-west-1\". Call the zone \"main\", the original db_instance \"primary\", the three replicas \"replica_us_east\", \"replica_eu_central\" and \"replica_ap_southeast\" respectively, and the provider aliases \"main\", \"us-east\", \"eu-central\", and \"ap-southeast\".",
    "Rego intent": "package terraform.validation\n\ndefault is_configuration_valid = false\n\ndefault is_valid_r53_zone = false\n\ndefault is_valid_r53_record_us = false\n\ndefault is_valid_r53_record_eu = false\n\ndefault is_valid_r53_record_ap = false\n\ndefault is_valid_db_instance_main = false\n\ndefault is_valid_db_instance_replicaus = false\n\ndefault is_valid_db_instance_replicaeu = false\n\ndefault is_valid_db_instance_replicaap = false\n\n\n# Validate aws_route53_zone resource\nis_valid_r53_zone {\n        some i\n    resource := input.configuration.root_module.resources[i]\n    resource.type == \"aws_route53_zone\"\n    resource.name == \"main\"\n    resource.provider_config_key == \"aws.main\"\n\n\n}\n\n# Validate aws_route53_record\nis_valid_r53_record_us {\n        some i\n    resource := input.configuration.root_module.resources[i]\n    resource.type == \"aws_route53_record\"\n    resource.provider_config_key == \"aws.us_east\"\n    resource.expressions.name\n    resource.expressions.weighted_routing_policy[0].weight\n    resource.expressions.type\n    resource.expressions.ttl\n    resource.expressions.records.references[0] == \"aws_db_instance.replica_us_east.endpoint\"\n    resource.expressions.set_identifier\n    resource.expressions.zone_id.references[0] == \"aws_route53_zone.main.zone_id\"\n}\n\nis_valid_r53_record_eu {\n        some i\n    resource := input.configuration.root_module.resources[i]\n    resource.type == \"aws_route53_record\"\n    resource.provider_config_key == \"aws.eu_central\"\n    resource.expressions.name\n    resource.expressions.weighted_routing_policy[0].weight\n    resource.expressions.type\n    resource.expressions.ttl\n    resource.expressions.records.references[0] == \"aws_db_instance.replica_eu_central.endpoint\"\n    resource.expressions.set_identifier\n    resource.expressions.zone_id.references[0] == \"aws_route53_zone.main.zone_id\"\n   }\n   \nis_valid_r53_record_ap {\n        some i\n    resource := input.configuration.root_module.resources[i]\n    resource.type == \"aws_route53_record\"\n    resource.provider_config_key == \"aws.ap_southeast\"\n    resource.expressions.name\n    resource.expressions.weighted_routing_policy[0].weight\n    resource.expressions.type\n    resource.expressions.ttl\n    resource.expressions.records.references[0] == \"aws_db_instance.replica_ap_southeast.endpoint\"\n    resource.expressions.set_identifier\n    resource.expressions.zone_id.references[0] == \"aws_route53_zone.main.zone_id\"\n   }\n\n# Rule to check if a valid aws_db_instance exists\nis_valid_db_instance_main {\n    resource := input.configuration.root_module.resources[_]\n    resource.type == \"aws_db_instance\"\n    resource.provider_config_key == \"aws.main\"\n    has_required_main_db_arguments\n}\n\nis_valid_db_instance_replicaus {\n    resource := input.configuration.root_module.resources[_]\n    resource.type == \"aws_db_instance\"\n    has_required_db_replicaus_arguments\n}\n\nis_valid_db_instance_replicaeu {\n    resource := input.configuration.root_module.resources[_]\n    resource.type == \"aws_db_instance\"\n    has_required_db_replicaeu_arguments\n}\n\nis_valid_db_instance_replicaap {\n    resource := input.configuration.root_module.resources[_]\n    resource.type == \"aws_db_instance\"\n    has_required_db_replicaap_arguments\n}\n\n# Helper rule to check if all required arguments are present and valid\nhas_required_main_db_arguments {\n    resource := input.configuration.root_module.resources[_]\n    resource.type == \"aws_db_instance\"\n    # Check for allocated_storage, engine, instance_class, username, password, and skip_final_snapshot\n    requirement1(resource.expressions)\n    # Check for instance_class validity\n    requirement2(resource.expressions)\n}\n\n\n\n# 1, allocated_storage and engine or snapshot_identifier or replace_source_db\nrequirement1(expressions) {\n    expressions.allocated_storage\n    expressions.engine\n    expressions.username\n    expressions.password\n    is_valid_engine(expressions.engine.constant_value)\n}\n\nrequirement1(expressions) {\n    expressions.snapshot_identifier\n}\n\n# Check for instance_class validity\nrequirement2(expressions) {\n    expressions.instance_class\n    is_valid_instance_class(expressions.instance_class.constant_value)\n}\n\n\n# Helper rule to validate engine value\nis_valid_engine(engine) {\n        engine_set := {\n        \"mysql\",\n        \"postgres\",\n        \"mariadb\",\n        \"oracle-se\",\n        \"oracle-se1\",\n        \"oracle-se2\",\n        \"oracle-ee\",\n        \"sqlserver-ee\",\n        \"sqlserver-se\",\n        \"sqlserver-ex\",\n        \"sqlserver-web\"\n    }\n        engine_set[engine]\n}\n\n# Helper rule to validate instance class type\nis_valid_instance_class(instance_class) {\n        instance_class_starts_with(instance_class, \"db.\")\n}\n\n# Helper rule to check prefix of instance class\ninstance_class_starts_with(instance_class, prefix) {\n        startswith(instance_class, prefix)\n}\n\nhas_required_db_replicaus_arguments {\n    resource := input.configuration.root_module.resources[_]\n    resource.type == \"aws_db_instance\"\n    resource.name == \"replica_us_east\"\n    resource.provider_config_key == \"aws.us_east\"\n    resource.expressions.replicate_source_db.references[0] == \"aws_db_instance.primary.arn\"\n    is_valid_instance_class(resource.expressions.instance_class.constant_value)\n    resource.expressions.skip_final_snapshot\n}\n\nhas_required_db_replicaeu_arguments {\n    resource := input.configuration.root_module.resources[_]\n    resource.type == \"aws_db_instance\"\n    resource.name == \"replica_eu_central\"\n    resource.provider_config_key == \"aws.eu_central\"\n    resource.expressions.replicate_source_db.references[0] == \"aws_db_instance.primary.arn\"\n    is_valid_instance_class(resource.expressions.instance_class.constant_value)\n    resource.expressions.skip_final_snapshot\n}\n\nhas_required_db_replicaap_arguments {\n    resource := input.configuration.root_module.resources[_]\n    resource.type == \"aws_db_instance\"\n    resource.name == \"replica_ap_southeast\"\n    resource.provider_config_key == \"aws.ap_southeast\"\n    resource.expressions.replicate_source_db.references[0] == \"aws_db_instance.primary.arn\"\n    is_valid_instance_class(resource.expressions.instance_class.constant_value)\n    resource.expressions.skip_final_snapshot\n}\n\n\n# Combine all checks into a final rule\nis_configuration_valid {\n    is_valid_r53_zone\n    is_valid_r53_record_us\n    is_valid_r53_record_eu\n    is_valid_r53_record_ap\n    is_valid_db_instance_main\n    is_valid_db_instance_replicaus\n    is_valid_db_instance_replicaeu\n    is_valid_db_instance_replicaap\n}\n\n\n",
    "Difficulty": 6,
    "Reference output": "terraform {\n  required_providers {\n    aws = {\n      source  = \"hashicorp/aws\"\n      version = \"~> 5.75\"\n      configuration_aliases = [ aws.main, aws.us_east, aws.eu_central, aws.ap_southeast ]\n    }\n  }\n\n  required_version = \"~> 1.9.8\"\n}\n\n\nprovider \"aws\" {\n  alias = \"main\"\n  region = \"us-west-2\" \n\n  profile = \"admin-1\"\n\n  assume_role {\n    role_arn = \"arn:aws:iam::590184057477:role/yicun-iac\"\n  }\n}\n\nprovider \"aws\" {\n  alias  = \"us_east\"\n  region = \"us-east-1\" # Example region for US East\n\n  profile = \"admin-1\"\n\n  assume_role {\n    role_arn = \"arn:aws:iam::590184057477:role/yicun-iac\"\n  }\n}\n\nprovider \"aws\" {\n  alias  = \"eu_central\"\n  region = \"eu-central-1\" # Example region for EU Central\n\n  profile = \"admin-1\"\n\n  assume_role {\n    role_arn = \"arn:aws:iam::590184057477:role/yicun-iac\"\n  }\n}\n\nprovider \"aws\" {\n  alias  = \"ap_southeast\"\n  region = \"ap-southeast-1\" # Example region for AP Southeast\n\n  profile = \"admin-1\"\n\n  assume_role {\n    role_arn = \"arn:aws:iam::590184057477:role/yicun-iac\"\n  }\n}\n\nresource \"aws_db_instance\" \"primary\" {\n  provider = aws.main\n  identifier = \"master\"\n  allocated_storage    = 20\n  engine               = \"postgres\"\n  instance_class       = \"db.t3.micro\"\n  username             = \"dbadmin\"\n  password             = \"your_password_here\"\n  skip_final_snapshot  = true\n  backup_retention_period  = 7\n}\n\nresource \"aws_db_instance\" \"replica_us_east\" {\n  provider             = aws.us_east\n  replicate_source_db  = aws_db_instance.primary.arn\n  instance_class       = \"db.t3.micro\"\n  identifier           = \"mydb-replica-us-east\"\n  skip_final_snapshot  = true\n}\n\nresource \"aws_db_instance\" \"replica_eu_central\" {\n  provider             = aws.eu_central\n  replicate_source_db  = aws_db_instance.primary.arn\n  instance_class       = \"db.t3.micro\"\n  identifier           = \"mydb-replica-eu-central\"\n  skip_final_snapshot  = true\n}\n\nresource \"aws_db_instance\" \"replica_ap_southeast\" {\n  provider             = aws.ap_southeast\n  replicate_source_db  = aws_db_instance.primary.arn\n  \n  instance_class       = \"db.t3.micro\"\n  identifier           = \"mydb-replica-ap-southeast\"\n  skip_final_snapshot  = true\n}\n\n# Route53 Hosted Zone\nresource \"aws_route53_zone\" \"main\" {\n  provider = aws.main\n  name = \"example53.com\"\n}\n\n\n# Route53 Records for each RDS Read Replica with a Weighted Routing Policy\nresource \"aws_route53_record\" \"replica_us_east_cname\" {\n  provider = aws.main\n\n  zone_id = aws_route53_zone.main.zone_id\n  name    = \"us.east.example53.com\"\n  type    = \"CNAME\"\n  records = [aws_db_instance.replica_us_east.endpoint]\n  ttl     = \"60\"\n  weighted_routing_policy {\n    weight = 30\n  }\n  set_identifier = \"replica-us-east\"\n}\n\nresource \"aws_route53_record\" \"replica_eu_central_cname\" {\n  provider = aws.main\n\n  zone_id = aws_route53_zone.main.zone_id\n  name    = \"eu.central.example53.com\"\n  type    = \"CNAME\"\n  records = [aws_db_instance.replica_eu_central.endpoint]\n  ttl     = \"60\"\n  weighted_routing_policy {\n    weight = 30\n  }\n  set_identifier = \"replica-eu-central\"\n}\n\nresource \"aws_route53_record\" \"replica_ap_southeast_cname\" {\n  provider = aws.main\n\n  zone_id = aws_route53_zone.main.zone_id\n  name    = \"ap.southeast.example53.com\"\n  type    = \"CNAME\"\n  records = [aws_db_instance.replica_ap_southeast.endpoint]\n  ttl     = \"60\"\n  weighted_routing_policy {\n    weight = 30\n  }\n  set_identifier = \"replica-ap-southeast\"\n}",
    "Intent": "Has one \"aws_route53_zone\" resource\n    with \"name\"\n\nHas a \"aws_db_instance\" resource\n    with \"identifier\" set to \"master\"\n    with \"instance_class\"\n    with \"allocated_storage\"\n    with \"engine\"\n    with \"username\"\n    with \"password\"\n    with \"backup_retention_period\" set to a non-zero number\n\nHas multiple \"aws_db_instance\" resources\n    with \"identifier\"\n    with \"replicate_source_db\" referencing the main \"aws_db_instance\" resource\n    with \"instance_class\"\n\nHas multiple \"aws_route53_record\" resources\n    with \"name\"\n    with \"type\"\n    with \"ttl\"\n    with \"zone_id\" referencing the \"aws_route53_zone\" resource\n    with \"weighted_routing_policy\" block that contains \"weight\" as a non-zero number\n    with \"records\" containing an endpoint of a corresponding replica of the main \"aws_db_instance\"\n\n"
  },
  {
    "index": 129,
    "difficulty": 5,
    "resource_types": [
      "aws_instance",
      "aws_db_instance",
      "aws_subnet",
      "aws_security_group",
      "aws_vpc",
      "aws_db_subnet_group"
    ],
    "num_resources": 6,
    "Resource": "aws_db_instance, aws_instance, aws_instance, aws_security_group, aws_subnet, aws_subnet, aws_subnet, aws_vpc",
    "Prompt": "Create VPC with three subnets: one public subnet and two private subnets. Create an EC2 instance in the public subnet running web servers, an EC2 instance in the private subnet running the application servers, and an RDS instance in the other private subnet serving as the database.",
    "Rego intent": "package main\n\nimport future.keywords.in\n\ndefault allow = false\n\nallow {\n    public_subnet_exists(input.resource_changes)\n    count(private_subnet_exists) == 2\n    count(aws_instances) == 2\n    rds_exist(input.resource_changes)\n}\n\npublic_subnet_exists(resources) {\n    some resource in resources\n    resource.type == \"aws_subnet\"\n    resource.change.after.map_public_ip_on_launch == true\n}\n\nprivate_subnet_exists[resource] {\n    resource := input.resource_changes[_]\n    resource.type == \"aws_subnet\"\n    resource.change.after.map_public_ip_on_launch == false\n}\n\nrds_exist(resources) {\n    some resource in resources\n    resource.type == \"aws_db_instance\"\n}\n\naws_instances[resource] {\n    resource := input.resource_changes[_]\n    resource.type == \"aws_instance\"\n}",
    "Difficulty": 5,
    "Reference output": "terraform {\n  required_providers {\n    aws = {\n      source  = \"hashicorp/aws\"\n      version = \"~> 5.75\"\n    }\n  }\n\n  required_version = \"~> 1.9.8\"\n}\n\nprovider \"aws\" {\n  region  = \"us-east-1\"\n  profile = \"admin-1\"\n\n  assume_role {\n    role_arn = \"arn:aws:iam::590184057477:role/yicun-iac\"\n  }\n}\n\n# Create a Virtual Private Cloud (VPC)\nresource \"aws_vpc\" \"my_vpc\" {\n  cidr_block = \"10.0.0.0/16\"\n}\n\ndata \"aws_availability_zones\" \"available\" {\n  state = \"available\"\n}\n\n# Create Public Subnet\nresource \"aws_subnet\" \"public_subnet\" {\n  vpc_id                  = aws_vpc.my_vpc.id\n  cidr_block              = \"10.0.1.0/24\"\n  availability_zone       = data.aws_availability_zones.available.names[0]\n  map_public_ip_on_launch = true\n}\n\n# Create Private Subnet 1\nresource \"aws_subnet\" \"private_subnet_1\" {\n  vpc_id            = aws_vpc.my_vpc.id\n  cidr_block        = \"10.0.2.0/24\"\n  availability_zone = data.aws_availability_zones.available.names[1]\n}\n\n# Create Private Subnet 2\nresource \"aws_subnet\" \"private_subnet_2\" {\n  vpc_id            = aws_vpc.my_vpc.id\n  cidr_block        = \"10.0.3.0/24\"\n  availability_zone = data.aws_availability_zones.available.names[2]\n}\n\n# Create Security Group for EC2 instances\nresource \"aws_security_group\" \"web_sg\" {\n  vpc_id = aws_vpc.my_vpc.id\n  name   = \"web_sg\"\n\n  # Define inbound and outbound rules as needed\n}\n\ndata \"aws_ami\" \"latest_amazon_linux_2\" {\n  most_recent = true\n  owners      = [\"amazon\"]\n\n  filter {\n    name   = \"name\"\n    values = [\"*ubuntu-noble-24.04-amd64-server-*\"]\n  }\n}\n\n# Create EC2 instance in the Public Subnet (Web Server)\nresource \"aws_instance\" \"web_instance\" {\n  ami             =  data.aws_ami.latest_amazon_linux_2.id\n  instance_type   = \"t2.micro\"\n  subnet_id       = aws_subnet.public_subnet.id\n  security_groups = [aws_security_group.web_sg.id]\n\n  # Additional configurations can be added as needed\n}\n\n# Create EC2 instance in Private Subnet 1 (Application Server)\nresource \"aws_instance\" \"app_instance\" {\n  ami           = data.aws_ami.latest_amazon_linux_2.id\n  instance_type = \"t2.micro\"\n  subnet_id     = aws_subnet.private_subnet_1.id\n\n  # Additional configurations can be added as needed\n}\n\nresource \"aws_db_subnet_group\" \"main\" {\n  name       = \"mydb-subnet-group\"\n  subnet_ids = [aws_subnet.private_subnet_1.id, aws_subnet.private_subnet_2.id]\n}\n\n# Create RDS instance in Private Subnet 2 (Database)\nresource \"aws_db_instance\" \"db_instance\" {\n  identifier           = \"mydb\"\n  engine               = \"mysql\"\n  instance_class       = \"db.t3.micro\"\n  allocated_storage    = 20\n  username             = \"admin\"\n  password             = \"your-password\" # Replace with your desired password\n  skip_final_snapshot  = true\n  db_subnet_group_name = aws_db_subnet_group.main.name\n}",
    "Intent": null
  },
  {
    "index": 310,
    "difficulty": 5,
    "resource_types": [
      "aws_iam_role",
      "aws_lambda_function",
      "aws_cloudwatch_event_rule",
      "aws_lambda_permission",
      "aws_iam_role_policy_attachment",
      "aws_cloudwatch_event_target"
    ],
    "num_resources": 6,
    "Resource": "aws_cloudwatch_event_rule, aws_cloudwatch_event_target, aws_iam_role, aws_iam_role_policy_attachment, aws_lambda_function, aws_lambda_permission, aws_iam_policy_document",
    "Prompt": "An AWS service that runs a code everyday at 7 UTC. Accomplish this using AWS EventBridge.",
    "Rego intent": "package job_scheduler_high\n\nimport rego.v1\n\nlambda_permission_valid(lambda_permission, lambda, rule) if {\n\tlambda_permission.expressions.action.constant_value == \"lambda:InvokeFunction\"\n\tlambda_permission.expressions.principal.constant_value == \"events.amazonaws.com\"\n\tlambda.address in lambda_permission.expressions.function_name.references\n\trule.address in lambda_permission.expressions.source_arn.references\n}\n\ntarget_valid(target, lambda, rule) if {\n\tlambda.address in target.expressions.arn.references\n\trule.address in target.expressions.rule.references\n}\n\nlambda_valid(lambda, role) if {\n\trole.address in lambda.expressions.role.references\n\tlambda.expressions.function_name\n\tlambda.expressions.filename\n\tlambda.expressions.handler\n\tlambda.expressions.runtime\n}\n\nrule_valid(rule, role) if {\n\trole.address in rule.expressions.role_arn.references\n\n\trule.expressions.schedule_expression.constant_value == \"cron(0 7 * * ? *)\"\n}\n\ndefault valid := false\n\nvalid if {\n\tresources := input.configuration.root_module.resources\n\n\tsome rule in resources\n\trule.type == \"aws_cloudwatch_event_rule\"\n\n\tsome role in resources\n\trole.type == \"aws_iam_role\"\n\n\tsome target in resources\n\ttarget.type == \"aws_cloudwatch_event_target\"\n\n\tsome lambda in resources\n\tlambda.type == \"aws_lambda_function\"\n\n\tsome lambda_permission in resources\n\tlambda_permission.type == \"aws_lambda_permission\"\n\n\trule_valid(rule, role)\n\tlambda_valid(lambda, role)\n\ttarget_valid(target, lambda, rule)\n\tlambda_permission_valid(lambda_permission, lambda, rule)\n}",
    "Difficulty": 5,
    "Reference output": "terraform {\n  required_providers {\n    aws = {\n      source  = \"hashicorp/aws\"\n      version = \"~> 5.75\"\n    }\n  }\n\n  required_version = \"~> 1.9.8\"\n}\n\nprovider \"aws\" {\n  region = \"us-east-1\"\n  profile = \"admin-1\"\n\n  assume_role {\n    role_arn = \"arn:aws:iam::590184057477:role/yicun-iac\"\n  }\n}\n\nresource \"aws_cloudwatch_event_rule\" \"cron\" {\n  schedule_expression = \"cron(0 7 * * ? *)\"\n\n  role_arn = aws_iam_role.cron.arn\n}\n\nresource \"aws_cloudwatch_event_target\" \"cron\" {\n  rule = aws_cloudwatch_event_rule.cron.name\n  arn  = aws_lambda_function.cron.arn\n}\n\ndata \"archive_file\" \"lambda-func\" {\n  type        = \"zip\"\n  source_file = \"./supplement/lambda_func.py\"\n  output_path = \"./supplement/lambda_func.zip\"\n}\n\nresource \"aws_lambda_function\" \"cron\" {\n  function_name = \"cron-lambda-function\"\n  role          = aws_iam_role.cron.arn\n  filename      = data.archive_file.lambda-func.output_path\n  source_code_hash = data.archive_file.lambda-func.output_base64sha256\n  handler       = \"lambda_func.handler\"\n  runtime       = \"python3.12\"\n}\n\nresource \"aws_lambda_permission\" \"cron\" {\n  function_name = aws_lambda_function.cron.function_name\n  action        = \"lambda:InvokeFunction\"\n  principal     = \"events.amazonaws.com\"\n  source_arn    = aws_cloudwatch_event_rule.cron.arn\n}\n\ndata \"aws_iam_policy_document\" \"cron_assume_role\" {\n  statement {\n    actions = [\"sts:AssumeRole\"]\n    principals {\n      type = \"Service\"\n      identifiers = [\n        \"lambda.amazonaws.com\",\n        \"events.amazonaws.com\"\n      ]\n    }\n  }\n}\n\nresource \"aws_iam_role\" \"cron\" {\n  name               = \"cron_assume_role\"\n  assume_role_policy = data.aws_iam_policy_document.cron_assume_role.json\n}\n\nresource \"aws_iam_role_policy_attachment\" \"cron\" {\n  role       = aws_iam_role.cron.name\n  policy_arn = \"arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole\"\n}",
    "Intent": "have one \"aws_cloudwatch_event_rule\" resource\n    with \"schedule_expression\" argument with value \"cron(0 7 * * ? *)\"\nhave one \"aws_cloudwatch_event_target\" resource\n    with \"rule\" argument\n    with \"arn\" argument\nhave one \"aws_lambda_function\" resource\n    with \"function_name\" argument\n    with \"role\" argument\n    with \"filename\" argument\n    with \"handler\" argument\n    with \"runtime\" argument\nhave one \"aws_lambda_permission\" resource\n    with \"function_name\" argument with value aws_lambda_function.cron.function_name\n    with \"action\" argument with value \"lambda:InvokeFunction\"\n    with \"principal\" argument with value \"events.amazonaws.com\"\n    with \"source_arn\" argument with value aws_cloudwatch_event_rule.cron.arn"
  },
  {
    "index": 108,
    "difficulty": 5,
    "resource_types": [
      "aws_s3_bucket_versioning",
      "aws_s3_bucket_public_access_block",
      "aws_s3_bucket",
      "aws_dynamodb_table",
      "aws_s3_bucket_server_side_encryption_configuration"
    ],
    "num_resources": 5,
    "Resource": "aws_dynamodb_table, aws_s3_bucket, aws_s3_bucket_public_access_block, aws_s3_bucket_server_side_encryption_configuration, aws_s3_bucket_versioning",
    "Prompt": "Set up an AWS S3 bucket and DynamoDB table for Terraform state management. Ensure the S3 bucket has preventive measures against accidental deletion and is configured with versioning enabled, server-side encryption using AES256, and public access restrictions. Create a DynamoDB table with a hash key named 'LockID' using 'PAY_PER_REQUEST' billing mode for Terraform locking.",
    "Rego intent": "package terraform.validation\n\ndefault has_s3_bucket_versioning = false\ndefault has_dynamodb_table = false\ndefault has_s3_bucket_server_side_encryption_configuration = false\ndefault has_s3_bucket_public_access_block = false\ndefault valid_configuration = false\n\n\n# Check for aws_s3_bucket_versioning resource with 'bucket' and 'status'\nhas_s3_bucket_versioning {\n    versioning := input.planned_values.root_module.resources[_]\n    versioning.type == \"aws_s3_bucket_versioning\"\n    versioning.values.versioning_configuration[_].status == \"Enabled\"\n}\n\n# Check for aws_dynamodb_table resource with 'name' and 'hash_key'\nhas_dynamodb_table {\n    some i\n    table := input.planned_values.root_module.resources[i]\n    table.type == \"aws_dynamodb_table\"\n    table.values.name != null\n    table.values.hash_key != null\n}\n\n# Check for aws_s3_bucket_server_side_encryption_configuration resource with 'bucket', 'rule', and 'sse_algorithm'\nhas_s3_bucket_server_side_encryption_configuration {\n    some i\n    encryption := input.planned_values.root_module.resources[i]\n    encryption.type == \"aws_s3_bucket_server_side_encryption_configuration\"\n    encryption.values.rule != null\n    encryption.values.rule[0].apply_server_side_encryption_by_default != null\n    encryption.values.rule[0].apply_server_side_encryption_by_default[0].sse_algorithm != null\n}\n\n# Check for aws_s3_bucket_public_access_block resource with 'bucket' and boolean flags\nhas_s3_bucket_public_access_block {\n    some i\n    access_block := input.planned_values.root_module.resources[i]\n    access_block.type == \"aws_s3_bucket_public_access_block\"\n    access_block.values.block_public_acls == true\n    access_block.values.block_public_policy == true\n    access_block.values.ignore_public_acls == true\n    access_block.values.restrict_public_buckets == true\n}\n\n# Combined validation rule\nvalid_configuration {\n    has_s3_bucket_versioning\n    has_dynamodb_table\n    has_s3_bucket_server_side_encryption_configuration\n    has_s3_bucket_public_access_block\n}\n",
    "Difficulty": 5,
    "Reference output": "terraform {\n  required_providers {\n    aws = {\n      source  = \"hashicorp/aws\"\n      version = \"~> 5.75\"\n    }\n  }\n\n  required_version = \"~> 1.9.8\"\n}\n\nprovider \"aws\" {\n  region  = \"us-east-1\"\n  profile = \"admin-1\"\n\n  assume_role {\n    role_arn = \"arn:aws:iam::590184057477:role/yicun-iac\"\n  }\n}\n\nresource \"aws_s3_bucket\" \"terraform_state\" {\n  bucket = \"iac-misc-terraform-state\"\n}\n\nresource \"aws_s3_bucket_versioning\" \"enabled\" {\n  bucket = aws_s3_bucket.terraform_state.id\n  versioning_configuration {\n    status = \"Enabled\"\n  }\n}\n\nresource \"aws_s3_bucket_server_side_encryption_configuration\" \"default\" {\n  bucket = aws_s3_bucket.terraform_state.id\n\n  rule {\n    apply_server_side_encryption_by_default {\n      sse_algorithm = \"AES256\"\n    }\n  }\n}\n\nresource \"aws_s3_bucket_public_access_block\" \"public_access\" {\n  bucket                  = aws_s3_bucket.terraform_state.id\n  block_public_acls       = true\n  block_public_policy     = true\n  ignore_public_acls      = true\n  restrict_public_buckets = true\n}\n\nresource \"aws_dynamodb_table\" \"terraform_locks\" {\n  name         = \"iac-misc-terraform-locks\"\n  billing_mode = \"PAY_PER_REQUEST\"\n  hash_key     = \"LockID\"\n\n  attribute {\n    name = \"LockID\"\n    type = \"S\"\n  }\n}",
    "Intent": "has one aws_s3_bucket_versioning resource\nwith bucket    \nwith status\n\nhas one aws_dynamodb_table resource\nwith name\nwith hash_key\n\nhas one aws_s3_bucket_lifecycle_configuration resource\nwith bucket \nwith rule\n    with id\n    with status\n    with action\n    with transition\n        with days\n        with storage_class\n\nhas one aws_s3_bucket_server_side_encryption_configuration resource\nwith bucket\nwith rule\n    with apply_server_side_encryption_by_default\n    with sse_algorithm\n\nhas one aws_s3_bucket_public_access_block resource\nwith bucket\nwith block_public_acls (boolean)\nwith block_public_policy (boolean)\nwith ignore_public_acls (boolean)\nwith restrict_public_buckets(boolean)\n\nhas one aws_dynamodb_table resource\nwith name  \nwith hash_key  \nwith attribute\n    with name\n    with type"
  },
  {
    "index": 426,
    "difficulty": 5,
    "resource_types": [
      "aws_subnet",
      "aws_vpc",
      "aws_route_table",
      "aws_route_table_association",
      "aws_internet_gateway"
    ],
    "num_resources": 5,
    "Resource": "aws_internet_gateway, aws_route_table, aws_route_table_association, aws_subnet, aws_vpc",
    "Prompt": "create a VPC in AWS with multiple public subnets and associates them with a route table configured for internet access via an internet gateway.",
    "Rego intent": "package terraform.validation\n\ndefault is_valid_vpc = false\n\ndefault is_valid_subnet = false\n\ndefault is_valid_internet_gateway = false\n\ndefault is_valid_route_table = false\n\ndefault is_valid_route_table_association = false\n\n# Validate aws_vpc resource\nis_valid_vpc {\n        some i\n        resource := input.configuration.root_module.resources[i]\n        resource.type == \"aws_vpc\"\n        resource.expressions.cidr_block != null\n        resource.expressions.enable_dns_hostnames.constant_value == true\n        resource.expressions.tags != null\n}\n\n# Validate aws_subnet resource\nis_valid_subnet {\n        some i\n        resource := input.configuration.root_module.resources[i]\n        resource.type == \"aws_subnet\"\n        resource.expressions.vpc_id.references != null\n        resource.expressions.cidr_block != null\n        resource.expressions.availability_zone != null\n        resource.expressions.tags != null\n}\n\n# Validate aws_internet_gateway resource\nis_valid_internet_gateway {\n        some i\n        resource := input.configuration.root_module.resources[i]\n        resource.type == \"aws_internet_gateway\"\n        resource.expressions.vpc_id.references != null\n}\n\n# Validate aws_route_table resource\nis_valid_route_table {\n        some i\n        resource := input.configuration.root_module.resources[i]\n        resource.type == \"aws_route_table\"\n        resource.expressions.vpc_id.references != null\n        resource.expressions.route != null\n        resource.expressions.tags != null\n}\n\n# Validate aws_route_table_association resource\nis_valid_route_table_association {\n        some i\n        resource := input.configuration.root_module.resources[i]\n        resource.type == \"aws_route_table_association\"\n        resource.expressions.subnet_id.references != null\n        resource.expressions.route_table_id.references != null\n}\n",
    "Difficulty": 5,
    "Reference output": "terraform {\n  required_providers {\n    aws = {\n      source  = \"hashicorp/aws\"\n      version = \"~> 5.75\"\n    }\n  }\n\n  required_version = \"~> 1.9.8\"\n}\n\nprovider \"aws\" {\n  region  = \"us-east-1\"\n  profile = \"admin-1\"\n\n  assume_role {\n    role_arn = \"arn:aws:iam::590184057477:role/yicun-iac\"\n  }\n}\n\ndata \"aws_availability_zones\" \"available\" {\n  state = \"available\"\n}\n\nlocals {\n  subnet_count = 2\n}\n\nresource \"aws_vpc\" \"_\" {\n  cidr_block           = \"10.0.0.0/16\"\n  enable_dns_hostnames = true\n}\n\nresource \"aws_subnet\" \"public\" {\n  count             = local.subnet_count\n  vpc_id            = aws_vpc._.id\n  cidr_block        = [\"10.0.1.0/24\",\n                      \"10.0.2.0/24\",\n                      \"10.0.3.0/24\",\n                      \"10.0.4.0/24\"][count.index]\n  availability_zone = data.aws_availability_zones.available.names[count.index]\n}\n\nresource \"aws_internet_gateway\" \"_\" {\n  vpc_id = aws_vpc._.id\n}\n\nresource \"aws_route_table\" \"public\" {\n  vpc_id = aws_vpc._.id\n  route {\n    cidr_block = \"0.0.0.0/0\"\n    gateway_id = aws_internet_gateway._.id\n  }\n}\n\nresource \"aws_route_table_association\" \"public\" {\n  count          = local.subnet_count\n  subnet_id      = aws_subnet.public[count.index].id\n  route_table_id = aws_route_table.public.id\n}",
    "Intent": "Has one \"aws_vpc\" resource\nwith a specified \"cidr_block\"\nwith \"enable_dns_hostnames\" set to true\nwith a \"tags\" map including a \"Name\" key\n\nHas one \"aws_subnet\" resources\nwith \"vpc_id\" referencing the \"aws_vpc\" resource\nwith specified \"cidr_block\" for each subnet\nin an indexed sequence with each subnet having a unique \"availability_zone\"\nwith a \"tags\" map including a \"Name\" key that uniquely identifies each subnet\n\nHas one \"aws_internet_gateway\" resource\nwith \"vpc_id\" referencing the \"aws_vpc\" resource\nwith a \"tags\" map including a \"Name\" key\n\nHas one \"aws_route_table\" resource\nwith \"vpc_id\" referencing the \"aws_vpc\" resource\ncontaining a default route for internet access through the \"aws_internet_gateway\"\nwith a \"tags\" map including a \"Name\" key\n\nHas multiple \"aws_route_table_association\" resources\nlinking each \"aws_subnet\" resource to the \"aws_route_table\" public\nwith \"subnet_id\" and \"route_table_id\" set appropriately for each subnet"
  },
  {
    "index": 59,
    "difficulty": 5,
    "resource_types": [
      "aws_kinesis_firehose_delivery_stream",
      "aws_iam_role",
      "aws_s3_bucket"
    ],
    "num_resources": 3,
    "Resource": "aws_iam_role, aws_kinesis_firehose_delivery_stream, aws_s3_bucket, aws_iam_policy_document",
    "Prompt": "Generate a Kinesis Firehose Delivery Stream with an extended S3 Destination with Dynamic Partitioning enabled",
    "Rego intent": "package terraform.validation\n\nimport future.keywords.in\n\ndefault has_valid_resources = false\n\nhas_valid_iam_role(resources) { \n        some resource in resources \n    resource.type == \"aws_iam_role\" \n    contains(resource.change.after.assume_role_policy,\"firehose.amazonaws.com\") \n}\n\nhas_valid_bucket {\n    some i\n    resource := input.planned_values.root_module.resources[i]\n    resource.type == \"aws_s3_bucket\"\n}\n\nhas_valid_firehose_delivery_stream {\n        some i\n        resource := input.planned_values.root_module.resources[i]\n    resource.type == \"aws_kinesis_firehose_delivery_stream\"\n    resource.values.name\n    resource.values.destination == \"extended_s3\"\n    resource.values.extended_s3_configuration[_].dynamic_partitioning_configuration\n        role := input.configuration.root_module.resources[i]\n    role.expressions.extended_s3_configuration[_].role_arn\n}\n\nhas_valid_resources {\n        has_valid_iam_role(input.resource_changes)\n        has_valid_bucket\n    has_valid_firehose_delivery_stream\n}",
    "Difficulty": 5,
    "Reference output": "terraform {\n  required_providers {\n    aws = {\n      source  = \"hashicorp/aws\"\n      version = \"~> 5.75\"\n    }\n  }\n\n  required_version = \"~> 1.9.8\"\n}\n\nprovider \"aws\" {\n  region  = \"us-east-1\"\n  profile = \"admin-1\"\n\n  assume_role {\n    role_arn = \"arn:aws:iam::590184057477:role/yicun-iac\"\n  }\n}\n\n# even though this program seems to be problematic, it's copied from https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/kinesis_firehose_delivery_stream\n# so I'll leave it unmodified\n\ndata \"aws_iam_policy_document\" \"firehose_assume_role\" {\n  statement {\n    effect = \"Allow\"\n\n    principals {\n      type        = \"Service\"\n      identifiers = [\"firehose.amazonaws.com\"]\n    }\n\n    actions = [\"sts:AssumeRole\"]\n  }\n}\n\nresource \"aws_iam_role\" \"firehose_role\" {\n  name               = \"firehose_test_role\"\n  assume_role_policy = data.aws_iam_policy_document.firehose_assume_role.json\n}\n\nresource \"aws_s3_bucket\" \"decemberthirtysecond\" {\n  bucket = \"decemberthirtysecond\"\n}\nresource \"aws_kinesis_firehose_delivery_stream\" \"extended_s3_stream\" {\n  name        = \"terraform-kinesis-firehose-extended-s3-test-stream\"\n  destination = \"extended_s3\"\n\n  extended_s3_configuration {\n    role_arn   = aws_iam_role.firehose_role.arn\n    bucket_arn = aws_s3_bucket.decemberthirtysecond.arn\n    buffering_size = 64\n\n    # https://docs.aws.amazon.com/firehose/latest/dev/dynamic-partitioning.html\n    dynamic_partitioning_configuration {\n      enabled = \"true\"\n    }\n\n    # Example prefix using partitionKeyFromQuery, applicable to JQ processor\n    prefix              = \"data/customer_id=!{partitionKeyFromQuery:customer_id}/year=!{timestamp:yyyy}/month=!{timestamp:MM}/day=!{timestamp:dd}/hour=!{timestamp:HH}/\"\n    error_output_prefix = \"errors/year=!{timestamp:yyyy}/month=!{timestamp:MM}/day=!{timestamp:dd}/hour=!{timestamp:HH}/!{firehose:error-output-type}/\"\n\n    processing_configuration {\n      enabled = \"true\"\n\n      # Multi-record deaggregation processor example\n      processors {\n        type = \"RecordDeAggregation\"\n        parameters {\n          parameter_name  = \"SubRecordType\"\n          parameter_value = \"JSON\"\n        }\n      }\n\n      # New line delimiter processor example\n      processors {\n        type = \"AppendDelimiterToRecord\"\n      }\n\n      # JQ processor example\n      processors {\n        type = \"MetadataExtraction\"\n        parameters {\n          parameter_name  = \"JsonParsingEngine\"\n          parameter_value = \"JQ-1.6\"\n        }\n        parameters {\n          parameter_name  = \"MetadataExtractionQuery\"\n          parameter_value = \"{customer_id:.customer_id}\"\n        }\n      }\n    }\n  }\n}",
    "Intent": "Has one \"aws_iam_role\" resource, one \"aws_s3_bucket\" resource, and one \"aws_kinesis_firehose_delivery_stream\" resource with the argument \"enabled\" within the \"dynamic_partitioning_configuration\" block set to \"true\"\n"
  },
  {
    "index": 152,
    "difficulty": 4,
    "resource_types": [
      "aws_lambda_alias",
      "aws_iam_policy",
      "aws_iam_role",
      "aws_lambda_function",
      "aws_dynamodb_table",
      "aws_iam_role_policy_attachment"
    ],
    "num_resources": 6,
    "Resource": "aws_dynamodb_table, aws_iam_role, aws_lambda_alias, aws_lambda_function, archive_file, aws_iam_policy_document",
    "Prompt": "Create a Lambda function alias for aws_lambda_function",
    "Rego intent": "package main\n\nimport future.keywords.in\n\ndefault allow = false\n\n# Check for Lambda Function URL Resource\naws_lambda_alias_valid(resources) {\n    some resource in resources\n    resource.type == \"aws_lambda_alias\"\n}\n\naws_lambda_function_valid(resources) {\n    some resource in resources\n    resource.type == \"aws_lambda_function\"\n}\n\n# Aggregate all checks\nallow {\n    aws_lambda_alias_valid(input.resource_changes)\n    aws_lambda_function_valid(input.resource_changes)\n}",
    "Difficulty": 4,
    "Reference output": "terraform {\n  required_providers {\n    aws = {\n      source  = \"hashicorp/aws\"\n      version = \"~> 5.75\"\n    }\n  }\n\n  required_version = \"~> 1.9.8\"\n}\n\n\nprovider \"aws\" {\n  region  = \"us-east-1\"\n  profile = \"admin-1\"\n\n  assume_role {\n    role_arn = \"arn:aws:iam::590184057477:role/yicun-iac\"\n  }\n}\n\nresource \"aws_dynamodb_table\" \"example_table\" {\n  name           = \"example_table\"\n  hash_key       = \"id\"\n  read_capacity  = 10\n  write_capacity = 10\n\n  attribute {\n    name = \"id\"\n    type = \"S\"\n  }\n\n  # Enable DynamoDB Streams\n  stream_enabled   = true\n  stream_view_type = \"NEW_AND_OLD_IMAGES\" # Choose as per your requirement\n\n  # Other configurations for your table\n}\n\ndata \"aws_iam_policy_document\" \"assume_role\" {\n  statement {\n    effect = \"Allow\"\n\n    principals {\n      type        = \"Service\"\n      identifiers = [\"lambda.amazonaws.com\"]\n    }\n\n    actions = [\"sts:AssumeRole\"]\n  }\n}\n\nresource \"aws_iam_role\" \"iam_for_lambda\" {\n  name               = \"iam_for_lambda\"\n  assume_role_policy = data.aws_iam_policy_document.assume_role.json\n}\n\nresource \"aws_iam_policy\" \"lambda_dynamodb_policy\" {\n  name   = \"lambda-dynamodb-policy\"\n  policy = jsonencode({\n    Version = \"2012-10-17\"\n    Statement = [\n      {\n        Action = [\n          \"dynamodb:GetItem\",\n          \"dynamodb:PutItem\",\n          \"dynamodb:UpdateItem\",\n          \"dynamodb:DeleteItem\"\n        ]\n        Effect   = \"Allow\"\n        Resource = aws_dynamodb_table.example_table.arn\n      }\n    ]\n  })\n}\n\nresource \"aws_iam_role_policy_attachment\" \"lambda_policy_attach\" {\n  role       = aws_iam_role.iam_for_lambda.name\n  policy_arn = aws_iam_policy.lambda_dynamodb_policy.arn\n}\n\ndata \"archive_file\" \"lambda\" {\n  type        = \"zip\"\n  source_file = \"./supplement/app.js\"\n  output_path = \"./supplement/app.zip\"\n}\n\nresource \"aws_lambda_function\" \"example_lambda\" {\n  filename      = data.archive_file.lambda.output_path\n  function_name = \"lambda_app_function\"\n  source_code_hash = data.archive_file.lambda.output_base64sha256\n  role          = aws_iam_role.iam_for_lambda.arn\n  handler       = \"app.handler\"\n  runtime       = \"nodejs18.x\"\n}\n\nresource \"aws_lambda_alias\" \"test_lambda_alias\" {\n  name             = \"my_alias\"\n  description      = \"a sample description\"\n  function_name    = aws_lambda_function.example_lambda.arn\n  function_version = \"$LATEST\"\n}",
    "Intent": "Needs to have an aws_lambda_function defined (IAM role, zip). Use aws_lambda_alias (need name, function_name, function_version)"
  }
]