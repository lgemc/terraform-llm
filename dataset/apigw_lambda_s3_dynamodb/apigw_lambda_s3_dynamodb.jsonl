{"instance_id": "terraform-aws-apigw-lambda-001", "problem_statement": "Create an API Gateway REST API named 'caas' with a resource endpoint 'cat' linking to two methods GET and PUT. Each method should integrate with a Lambda function that can access an S3 bucket for storing cat images and a DynamoDB table for tracking names. Include proper IAM roles, Lambda permissions, API deployment and stage.", "difficulty": "hard", "tags": ["api-gateway", "lambda", "s3", "dynamodb", "serverless", "aws"], "provider": "aws", "region": "us-east-1", "expected_resources": {"aws_api_gateway_rest_api": 1, "aws_api_gateway_resource": 1, "aws_api_gateway_method": 2, "aws_api_gateway_integration": 2, "aws_api_gateway_deployment": 1, "aws_api_gateway_stage": 1, "aws_lambda_function": 1, "aws_lambda_permission": 1, "aws_iam_role": 1, "aws_iam_role_policy": 1, "aws_s3_bucket": 1, "aws_dynamodb_table": 1}, "required_outputs": ["api_id", "stage_invoke_url"], "validation_script": "dataset/apigw_lambda_s3_dynamodb/validation.py", "gold_solution": {"main.tf": "resource \"aws_dynamodb_table\" \"caas\" {\n  name         = \"cat_names\"\n  hash_key     = \"name\"\n  billing_mode = \"PAY_PER_REQUEST\"\n\n  attribute {\n    name = \"name\"\n    type = \"S\"\n  }\n}\n\nresource \"aws_s3_bucket\" \"caas\" {\n  bucket_prefix = \"cat-image\"\n}\n\nresource \"aws_iam_role\" \"lambda_role\" {\n  name = \"lambda_api_gateway_role\"\n\n  assume_role_policy = jsonencode({\n    Version = \"2012-10-17\"\n    Statement = [\n      {\n        Action = \"sts:AssumeRole\"\n        Effect = \"Allow\"\n        Principal = {\n          Service = \"lambda.amazonaws.com\"\n        }\n      }\n    ]\n  })\n}\n\nresource \"aws_iam_role_policy\" \"lambda_policy\" {\n  name   = \"lambda_policy\"\n  role   = aws_iam_role.lambda_role.id\n  policy = jsonencode({\n    Version = \"2012-10-17\"\n    Statement = [\n      {\n        Action   = [\"s3:GetObject\", \"s3:PutObject\"]\n        Effect   = \"Allow\"\n        Resource = \"${aws_s3_bucket.caas.arn}/*\"\n      },\n      {\n        Action   = [\"dynamodb:PutItem\"]\n        Effect   = \"Allow\"\n        Resource = aws_dynamodb_table.caas.arn\n      }\n    ]\n  })\n}\n\nresource \"aws_api_gateway_rest_api\" \"caas\" {\n  name = \"caas\"\n}\n\nresource \"aws_api_gateway_resource\" \"caas_cat\" {\n  rest_api_id = aws_api_gateway_rest_api.caas.id\n  parent_id   = aws_api_gateway_rest_api.caas.root_resource_id\n  path_part   = \"cat\"\n}\n\nresource \"aws_api_gateway_method\" \"caas_cat_get\" {\n  rest_api_id   = aws_api_gateway_rest_api.caas.id\n  resource_id   = aws_api_gateway_resource.caas_cat.id\n  http_method   = \"GET\"\n  authorization = \"NONE\"\n}\n\nresource \"aws_api_gateway_method\" \"caas_cat_put\" {\n  rest_api_id   = aws_api_gateway_rest_api.caas.id\n  resource_id   = aws_api_gateway_resource.caas_cat.id\n  http_method   = \"PUT\"\n  authorization = \"NONE\"\n}\n\ndata \"archive_file\" \"caas_cat\" {\n  type        = \"zip\"\n  source_file = \"${path.module}/lambda_code/handler.py\"\n  output_path = \"${path.module}/lambda_code/handler.zip\"\n}\n\nresource \"aws_lambda_function\" \"caas_cat\" {\n  function_name    = \"caas_cat\"\n  role             = aws_iam_role.lambda_role.arn\n  filename         = data.archive_file.caas_cat.output_path\n  source_code_hash = data.archive_file.caas_cat.output_base64sha256\n  handler          = \"handler.handler\"\n  runtime          = \"python3.12\"\n\n  environment {\n    variables = {\n      CAAS_S3_BUCKET      = aws_s3_bucket.caas.id\n      DYNAMODB_TABLE_NAME = aws_dynamodb_table.caas.id\n    }\n  }\n}\n\nresource \"aws_api_gateway_integration\" \"caas_cat_get\" {\n  rest_api_id             = aws_api_gateway_rest_api.caas.id\n  resource_id             = aws_api_gateway_resource.caas_cat.id\n  http_method             = aws_api_gateway_method.caas_cat_get.http_method\n  type                    = \"AWS_PROXY\"\n  integration_http_method = \"POST\"\n  uri                     = aws_lambda_function.caas_cat.invoke_arn\n}\n\nresource \"aws_api_gateway_integration\" \"caas_cat_put\" {\n  rest_api_id             = aws_api_gateway_rest_api.caas.id\n  resource_id             = aws_api_gateway_resource.caas_cat.id\n  http_method             = aws_api_gateway_method.caas_cat_put.http_method\n  type                    = \"AWS_PROXY\"\n  integration_http_method = \"POST\"\n  uri                     = aws_lambda_function.caas_cat.invoke_arn\n}\n\nresource \"aws_lambda_permission\" \"caas_cat\" {\n  action        = \"lambda:InvokeFunction\"\n  principal     = \"apigateway.amazonaws.com\"\n  function_name = aws_lambda_function.caas_cat.function_name\n  source_arn    = \"${aws_api_gateway_rest_api.caas.execution_arn}/*/*\"\n}\n\nresource \"aws_api_gateway_deployment\" \"api_deployment\" {\n  rest_api_id = aws_api_gateway_rest_api.caas.id\n  depends_on  = [aws_api_gateway_integration.caas_cat_get, aws_api_gateway_integration.caas_cat_put]\n}\n\nresource \"aws_api_gateway_stage\" \"api_stage\" {\n  deployment_id = aws_api_gateway_deployment.api_deployment.id\n  rest_api_id   = aws_api_gateway_rest_api.caas.id\n  stage_name    = \"dev\"\n}\n\noutput \"api_id\" {\n  value = aws_api_gateway_rest_api.caas.id\n}\n\noutput \"stage_invoke_url\" {\n  value = aws_api_gateway_stage.api_stage.invoke_url\n}\n"}, "hints": ["Use aws_api_gateway_rest_api with a name", "Create a resource with path_part and link to rest_api", "Create GET and PUT methods on the resource", "Use AWS_PROXY integration type for Lambda", "Lambda needs IAM role with S3 and DynamoDB permissions", "Don't forget aws_api_gateway_deployment and aws_api_gateway_stage", "Add aws_lambda_permission for API Gateway to invoke Lambda", "Use data \"archive_file\" to zip lambda_code/handler.py for the Lambda deployment package instead of referencing a pre-built zip"], "metadata": {"estimated_cost": "$0.00", "deployment_time_seconds": 180, "cleanup_required": true, "created_at": "2025-02-25", "author": "iac-eval"}, "setup_script": "dataset/apigw_lambda_s3_dynamodb/setup.sh"}
